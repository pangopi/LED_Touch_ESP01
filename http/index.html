<!DOCTYPE html>
<html>
<head>
    <title>JavaScript MQTT ESP test</title>
    <!--<script src="mqttws31.js"></script>-->
    <script src="./mqttws31.min.js" type="text/javascript"></script>
    <style>
        button {
            margin: 2px;
            padding: 5px 12px;
        }
    </style>
</head>
<body>
    <script>
        const states = ["Off", "On", "Changing", "Delay Off"]; 
        // Create a client instance: Broker, Port, Websocket Path, Client ID
        client = new Paho.MQTT.Client("192.168.5.1", Number(9001), "/ws", "Websocket" + Math.floor(Math.random() * 1001));

        // set callback handlers
        client.onConnectionLost = function (responseObject) {
            console.log("Connection Lost: "+responseObject.errorMessage);
            connect();
        }

        client.onMessageArrived = function (message) {
            console.log("Message Arrived: " + message.payloadString);
            // console.log("Topic:     " + message.destinationName);
            // console.log("QoS:       " + message.qos);
            // console.log("Retained:  " + message.retained);

            if (message.destinationName == "salon/light/main") {
                var status = JSON.parse(message.payloadString);
                if (status.State >= 0) {
                    document.getElementById('state').innerHTML = states[status.State];
                }
                if (status.Intensity >= 0) {
                    document.getElementById('intensity').innerHTML = status.Intensity;
                    document.getElementById('sliderSalon').value = status.Intensity;
                }
            }
        }

        // Called when the connection is made
        function onConnect(){
            console.log("Connected!");

            // Send message
            var message = new Paho.MQTT.Message("Websocket connected");
            message.destinationName = "housekeeping";
            message.qos = 0; // Optional, default 0
            client.send(message);

            client.subscribe("salon/light/main");
            client.subscribe("salon/light/main/command");
            client.subscribe("housekeeping");
        }

        // Connect the client, with a Username and Password
        function connect(){
            client.connect({
                onSuccess: onConnect, 
                userName : "pangolin",
                password : "mikeharris"
            });
        }
        
        function publish(topic, payload){
            // Publish to MQTT
            var message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            message.qos = 0;
            client.send(message);
        };

        connect();

    </script>

    <h1>Salon light</h1>
    <p>
        State: <b id="state">Unknown</b>
        Intensity: <b id="intensity">Unknown</b>
    </p>
    <p>
        <input type="range" min="0" max="255" value="0" class="slider" id="sliderSalon" style="width:300px;" />
        <br>
        <button onclick='publish("salon/light/main/command", "{\"state\":2,\"intensity\":0}")'>OFF</button> 
        <button onclick='publish("salon/light/main/command", "{\"state\":2,\"intensity\":64}")'>Min</button> 
        <button onclick='publish("salon/light/main/command", "{\"state\":2,\"intensity\":128}")'>Half</button> 
        <button onclick='publish("salon/light/main/command", "{\"state\":2,\"intensity\":192}")'>3/4</button> 
        <button onclick='publish("salon/light/main/command", "{\"state\":2,\"intensity\":255}")'>Full</button>
        <br>

        <!--
        Schedule On: <input type="text" id="cronOn" /> (min hour monthday month weekday)
        <button onclick='publish("salon/light/main/command", 
            "{\"state\":2,\"intensity\":" + 
            document.getElementById("sliderSalon").value + ",\"cronStr\":\"" + 
            document.getElementById("cronOn").value + 
            "\",\"cronAction\":0}")'>Set</button>
        <br>
        Schedule Off: <input type="text" id="cronOff" /> (min hour monthday month weekday)
        <button onclick='publish("salon/light/main/command", 
            "{\"state\":2,\"intensity\":0,\"cronStr\":\"" + 
            document.getElementById("cronOff").value + 
            "\",\"cronAction\":0}")'>Set</button>
        -->
        
    </p>

    <!--
    <h1>Galley light</h1>
    <button onclick='publish("salon/light/galley/command", "{\"state\":2,\"intensity\":0}")'>OFF</button> 
    <button onclick='publish("salon/light/galley/command", "{\"state\":2,\"intensity\":64}")'>Min</button> 
    <button onclick='publish("salon/light/galley/command", "{\"state\":2,\"intensity\":128}")'>Half</button> 
    <button onclick='publish("salon/light/galley/command", "{\"state\":2,\"intensity\":192}")'>3/4</button> 
    <button onclick='publish("salon/light/galley/command", "{\"state\":2,\"intensity\":255}")'>Full</button>
    -->

<script>

    var sliderSalon = document.getElementById("sliderSalon");

    // Update the current slider value (each time you drag the slider handle)
    sliderSalon.oninput = function() {
        publish("salon/light/main/command", "{\"state\":2,\"intensity\":" + this.value + "}");
    } 
</script>
</body>
</html>
